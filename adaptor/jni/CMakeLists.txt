project(spvadaptorjni VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_VERBOSE_MAKEFILE TRUE)

FIND_PACKAGE(JNI REQUIRED)
FIND_PACKAGE(Java REQUIRED)

include(ProjectDefaults)

# JNI wrapper was generated by SWIG
# swig -java -module SPVAdaptor \
#       -package org.elastos.did.adaptor \
#       -outdir java/org/elastos/did/adaptor \
#       -o spvadaptor_wrap.c \
#       spvadaptor.i

if(NOT DEFINED JDK_HOME)
    if (NOT DEFINED ENV{JDK_HOME})
        message(FATAL_ERROR "JDK_HOME variable not set.")
    endif()

    set(JDK_HOME $ENV{JDK_HOME})
endif()

set(SRC
    spvadaptor_wrap.c)

set(LIBS
    spvadaptor-static
    spvsdk
    curl)

set(SYSTEM_LIBS
    z)

include_directories(
    BEFORE
    ../spvadaptor
    ${JDK_HOME}/include
    ${JDK_HOME}/include/darwin
    ${JDK_HOME}/include/linux
    ${PROJECT_INT_DIST_DIR}/include)

if(DARWIN)
    set(CMAKE_SHARED_LIBRARY_SUFFIX .jnilib)
endif()

if(WIN32)
    add_definitions(
        -DWIN32_LEAN_AND_MEAN
        -D_CRT_SECURE_NO_WARNINGS
        -D_CRT_NONSTDC_NO_WARNINGS)

    # Force source code encoding to utf-8
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /utf-8")
endif()

link_directories(
    ${JDK_HOME}/lib
    ${PROJECT_INT_DIST_DIR}/lib)

set(SPVADAPTORJNI_DEPENDS spvadaptor)

add_library(spvadaptorjni SHARED ${SRC})
add_dependencies(spvadaptorjni ${SPVADAPTORJNI_DEPENDS})

set_target_properties(spvadaptorjni PROPERTIES
    OUTPUT_NAME spvadaptorjni)

if(WIN32)
    set_target_properties(spvadaptorjni PROPERTIES LINK_FLAGS /FORCE:MULTIPLE)
endif()

target_link_libraries(spvadaptorjni ${LIBS} ${SYSTEM_LIBS})

install(TARGETS spvadaptorjni
    RUNTIME DESTINATION "bin"
    ARCHIVE DESTINATION "lib"
    LIBRARY DESTINATION "lib")
